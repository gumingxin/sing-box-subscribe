name: Convert_Xiaoxin_JSON_to_SRS

on:
  workflow_dispatch:          # 手动触发
  push:
    paths:
      - 'xiaoxin/*.json'     # xiaoxin 下 JSON 文件有变动自动触发
  schedule:
    - cron: '0 18 * * *'     # UTC 18:00 (北京时间 02:00)

jobs:
  convert-rules:
    runs-on: windows-latest

    steps:
      # 1. 检出仓库
      - name: Checkout repository
        uses: actions/checkout@v2

      # 2. 下载 sing-box.exe（仅当 GitHub 原文件更新或本地缺失）
      - name: Download sing-box.exe if missing or changed
        shell: powershell
        run: |
          $exePath = "./sing-box.exe"
          $exeUrl  = "https://github.com/gumingxin/sing-box-subscribe/raw/refs/heads/main/sing-box.exe"
          $tempExe = "./sing-box_temp.exe"

          # 下载最新的 sing-box.exe 到临时文件
          Invoke-WebRequest -Uri $exeUrl -OutFile $tempExe -UseBasicParsing

          # 判断是否和本地现有文件不同
          $needUpdate = $true
          if (Test-Path $exePath) {
              $hashOld = Get-FileHash $exePath -Algorithm SHA256
              $hashNew = Get-FileHash $tempExe -Algorithm SHA256
              if ($hashOld.Hash -eq $hashNew.Hash) {
                  $needUpdate = $false
              }
          }

          if ($needUpdate) {
              Write-Host "Updating sing-box.exe..."
              Move-Item -Path $tempExe -Destination $exePath -Force
          } else {
              Write-Host "sing-box.exe is up-to-date."
              Remove-Item $tempExe
          }

      # 3. 编译 xiaoxin 下 JSON → SRS
      - name: Convert JSON to SRS
        shell: powershell
        run: |
          $exePath = "./sing-box.exe"
          $jsonFiles = Get-ChildItem -Path "xiaoxin" -Filter "*.json"

          foreach ($json in $jsonFiles) {
            $srsFile = [System.IO.Path]::ChangeExtension($json.FullName, ".srs")
            Write-Host "Converting $($json.Name) -> $(Split-Path $srsFile -Leaf)"
            & $exePath rule-set compile --output $srsFile $json.FullName

            if ($LASTEXITCODE -ne 0) {
              Write-Error "Conversion failed for $($json.Name)"
              exit 1
            }
          }

      # 4. 检查变化再提交
      - name: Commit and Push only if changed
        env:
          TOKEN: ${{ secrets.TOKEN }}
        shell: powershell
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git add sing-box.exe
          git add xiaoxin/*.srs

          $status = git status --porcelain
          if ($status) {
            Write-Host "Changes detected, committing..."
            git commit -m "Auto-update sing-box.exe and compile JSON → SRS"
            git push https://${{ secrets.TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
          } else {
            Write-Host "No changes in SRS or sing-box.exe, skipping commit."
          }
